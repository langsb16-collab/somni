<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>요가 & 스트레칭 - SomniCare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .sleep-gradient { background: linear-gradient(135deg, #1f7ed6 0%, #1560a8 100%); }
        .yoga-gradient { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .routine-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .step-indicator { width: 32px; height: 32px; background: #4facfe; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="sleep-gradient text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="/wellness" class="flex items-center space-x-3">
                    <i class="fas fa-spa text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold">요가 & 스트레칭</h1>
                        <p class="text-xs opacity-90">SomniCare 웰니스</p>
                    </div>
                </a>
                <div class="flex items-center space-x-4">
                    <a href="/wellness" class="text-sm hover:opacity-80"><i class="fas fa-arrow-left mr-1"></i>웰니스 허브</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="yoga-gradient text-white py-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold mb-3">
                <i class="fas fa-spa mr-2"></i>
                수면 요가 & 스트레칭
            </h2>
            <p class="text-lg mb-2 opacity-90">
                취침 전/기상 후 간단한 이완 루틴으로 숙면 준비
            </p>
            <p class="text-sm opacity-80">
                <i class="fas fa-info-circle mr-1"></i>
                통증이나 질환이 있는 경우 의료진과 상담 후 진행하세요
            </p>
        </div>
    </section>

    <!-- Filter Tabs -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="flex flex-wrap gap-2 justify-center mb-8">
            <button class="filter-btn bg-blue-600 text-white px-6 py-2 rounded-full font-semibold transition" data-category="all">
                전체
            </button>
            <button class="filter-btn bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-semibold transition hover:bg-gray-300" data-category="bedtime_stretch">
                취침 전 이완
            </button>
            <button class="filter-btn bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-semibold transition hover:bg-gray-300" data-category="morning_wakeup">
                기상 후 순환
            </button>
            <button class="filter-btn bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-semibold transition hover:bg-gray-300" data-category="neck_shoulder">
                목/어깨 이완
            </button>
        </div>

        <!-- Yoga Routines List -->
        <div id="yogaList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Loaded dynamically -->
        </div>
    </div>

    <!-- Routine Player Modal -->
    <div id="playerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-4 flex items-center justify-between">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="p-6">
                <!-- Progress -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-gray-600">진행 상황</span>
                        <span id="progressText" class="text-sm font-semibold text-blue-600">0 / 0</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Current Step -->
                <div id="stepContent" class="mb-6">
                    <!-- Loaded dynamically -->
                </div>

                <!-- Controls -->
                <div class="flex gap-3">
                    <button id="prevStep" class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg font-bold hover:bg-gray-300 transition" disabled>
                        <i class="fas fa-arrow-left mr-2"></i>이전
                    </button>
                    <button id="nextStep" class="flex-1 bg-blue-600 text-white py-4 rounded-lg font-bold hover:bg-blue-700 transition">
                        다음<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>

                <!-- Speed Control -->
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-gray-600">재생 속도</span>
                        <span id="speedValue" class="text-sm font-semibold text-blue-600">1.0x</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="speed-btn flex-1 py-2 px-4 bg-white border-2 border-gray-300 rounded-lg font-semibold text-sm hover:border-blue-600 hover:text-blue-600 transition" data-speed="0.8">
                            0.8x 느리게
                        </button>
                        <button class="speed-btn flex-1 py-2 px-4 bg-blue-600 text-white border-2 border-blue-600 rounded-lg font-semibold text-sm" data-speed="1.0">
                            1.0x 보통
                        </button>
                        <button class="speed-btn flex-1 py-2 px-4 bg-white border-2 border-gray-300 rounded-lg font-semibold text-sm hover:border-blue-600 hover:text-blue-600 transition" data-speed="1.2">
                            1.2x 빠르게
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        let yogaData = [];
        let currentRoutine = null;
        let currentStep = 0;
        let playbackSpeed = 1.0;

        // Load yoga routines
        async function loadYoga(category = 'all') {
            try {
                const response = await axios.get('/api/wellness/yoga');
                yogaData = response.data.yoga || [];
                
                const filtered = category === 'all' 
                    ? yogaData 
                    : yogaData.filter(y => y.category === category);
                
                displayYoga(filtered);
            } catch (error) {
                console.error('Failed to load yoga:', error);
                document.getElementById('yogaList').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-exclamation-circle text-red-500 text-5xl mb-4"></i>
                        <p class="text-gray-600">요가 루틴을 불러올 수 없습니다</p>
                    </div>
                `;
            }
        }

        // Display yoga
        function displayYoga(yoga) {
            const list = document.getElementById('yogaList');
            
            if (yoga.length === 0) {
                list.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-spa text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-600">해당 카테고리의 요가 루틴이 없습니다</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = yoga.map(item => `
                <div class="routine-card card-hover">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800 mb-1">${item.title}</h3>
                            <div class="flex items-center gap-3 text-sm text-gray-600">
                                <span><i class="far fa-clock mr-1"></i>${Math.floor(item.duration_seconds / 60)}분</span>
                                <span class="px-2 py-1 bg-${getDifficultyColor(item.difficulty)}-100 text-${getDifficultyColor(item.difficulty)}-700 rounded-full text-xs font-semibold">
                                    ${getDifficultyLabel(item.difficulty)}
                                </span>
                            </div>
                        </div>
                        <div class="text-yellow-500">
                            <i class="fas fa-star"></i>
                            <span class="text-sm font-semibold">${item.rating}</span>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-4">${item.description}</p>
                    
                    <div class="flex items-center gap-2 mb-4 flex-wrap">
                        ${JSON.parse(item.benefits || '[]').map(benefit => `
                            <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs">
                                <i class="fas fa-check mr-1"></i>${benefit}
                            </span>
                        `).join('')}
                    </div>
                    
                    <button class="start-routine-btn w-full bg-gradient-to-r from-blue-400 to-cyan-400 text-white py-3 rounded-lg font-bold hover:opacity-90 transition" data-id="${item.id}">
                        <i class="fas fa-play mr-2"></i>루틴 시작하기
                    </button>
                    
                    ${item.warnings ? `
                        <p class="mt-3 text-xs text-orange-600">
                            <i class="fas fa-exclamation-triangle mr-1"></i>${item.warnings}
                        </p>
                    ` : ''}
                </div>
            `).join('');
            
            // Add event listeners
            document.querySelectorAll('.start-routine-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    const routine = yogaData.find(y => y.id == id);
                    if (routine) startRoutine(routine);
                });
            });
        }

        // Start routine
        function startRoutine(routine) {
            currentRoutine = routine;
            currentStep = 0;
            playbackSpeed = 1.0;
            
            document.getElementById('modalTitle').textContent = routine.title;
            document.getElementById('playerModal').classList.remove('hidden');
            document.getElementById('playerModal').classList.add('flex');
            
            updateStep();
        }

        // Update step
        function updateStep() {
            if (!currentRoutine) return;
            
            const steps = JSON.parse(currentRoutine.steps || '[]');
            const totalSteps = steps.length;
            
            if (currentStep >= totalSteps) {
                // Completed
                completeRoutine();
                return;
            }
            
            const step = steps[currentStep];
            const progress = ((currentStep) / totalSteps) * 100;
            
            document.getElementById('progressText').textContent = `${currentStep + 1} / ${totalSteps}`;
            document.getElementById('progressFill').style.width = `${progress}%`;
            
            document.getElementById('stepContent').innerHTML = `
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-6">
                    <div class="flex items-start gap-4 mb-4">
                        <div class="step-indicator flex-shrink-0">${currentStep + 1}</div>
                        <div class="flex-1">
                            <h4 class="text-xl font-bold text-gray-800 mb-2">${step.title}</h4>
                            <p class="text-gray-700 leading-relaxed">${step.description}</p>
                        </div>
                    </div>
                    
                    ${step.duration ? `
                        <div class="bg-white rounded-lg p-4 mb-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold text-gray-600">권장 시간</span>
                                <span class="text-2xl font-bold text-blue-600">
                                    ${Math.floor(step.duration * playbackSpeed)}초
                                </span>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${step.illustration ? `
                        <div class="mt-4">
                            <img src="${step.illustration}" alt="${step.title}" class="w-full rounded-lg">
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Update buttons
            document.getElementById('prevStep').disabled = currentStep === 0;
            document.getElementById('nextStep').textContent = currentStep === totalSteps - 1 
                ? '완료' 
                : '다음';
        }

        // Complete routine
        function completeRoutine() {
            document.getElementById('stepContent').innerHTML = `
                <div class="text-center py-12">
                    <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-white text-4xl"></i>
                    </div>
                    <h4 class="text-2xl font-bold text-gray-800 mb-2">루틴 완료!</h4>
                    <p class="text-gray-600 mb-6">오늘의 요가 스트레칭을 완료했습니다</p>
                    <button id="closeAfterComplete" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition">
                        닫기
                    </button>
                </div>
            `;
            
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = '완료!';
            
            // Log activity
            logActivity();
            
            document.getElementById('closeAfterComplete').addEventListener('click', () => {
                document.getElementById('playerModal').classList.add('hidden');
                document.getElementById('playerModal').classList.remove('flex');
            });
        }

        // Log activity
        async function logActivity() {
            try {
                await axios.post('/api/wellness/activities', {
                    activity_type: 'yoga',
                    content_id: currentRoutine.id,
                    content_title: currentRoutine.title,
                    duration_seconds: currentRoutine.duration_seconds,
                    completed: true,
                    rating: 5
                });
            } catch (error) {
                console.error('Failed to log activity:', error);
            }
        }

        // Event listeners
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('playerModal').classList.add('hidden');
            document.getElementById('playerModal').classList.remove('flex');
        });

        document.getElementById('prevStep').addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                updateStep();
            }
        });

        document.getElementById('nextStep').addEventListener('click', () => {
            currentStep++;
            updateStep();
        });

        // Speed control
        document.querySelectorAll('.speed-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                playbackSpeed = parseFloat(btn.dataset.speed);
                document.getElementById('speedValue').textContent = `${playbackSpeed}x`;
                
                document.querySelectorAll('.speed-btn').forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                    b.classList.add('bg-white', 'border-gray-300');
                });
                btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.remove('bg-white', 'border-gray-300');
                
                updateStep();
            });
        });

        // Category filter
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('bg-gray-200', 'text-gray-700');
                });
                btn.classList.add('bg-blue-600', 'text-white');
                btn.classList.remove('bg-gray-200', 'text-gray-700');
                
                const category = btn.dataset.category;
                loadYoga(category);
            });
        });

        // Helper functions
        function getDifficultyLabel(difficulty) {
            const labels = {
                beginner: '초급',
                intermediate: '중급',
                advanced: '고급'
            };
            return labels[difficulty] || difficulty;
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                beginner: 'green',
                intermediate: 'yellow',
                advanced: 'red'
            };
            return colors[difficulty] || 'gray';
        }

        // Initialize
        loadYoga();
    </script>
</body>
</html>
